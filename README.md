# 云函数部署

首先，你应该切换到了本分支，本分支增加了构建打包功能

## 核心文件

主要关注这几个文件：

- `.env`：控制环境变量的，如企业ID、应用ID、天行key等
- `config.yml`：项目配置文件
- `package.json`：依赖管理文件

## 执行构建命令

在命令行中执行如下命令：

```sh
npm run build
```

该命令首先会进行代码构建打包，输出 `dist/build.js`文件，`lib/index.js`文件

- `dist/build.js`：全量打包、会压缩代码，不再需要安装任何依赖，所有代码都打包成了一个文件，可以直接运行。
- `lib/index.js`：只打包源代码，依赖还是需要安装的，才可以继续使用

其次，该命令在构建完成之后，会自动移动核心文件至 `deploy` 文件夹，你只需要关注这个文件夹即可，后面配置云函数的时候，直接上传这个文件即可。

## 云函数步骤

> 这里以腾讯云函数为例

1. 随便注册一个账号，然后选择菜单入口

    ![菜单入口](/images/yun1.png)

2. 新建，基础配置

    ![基础配置](/images/yun2.png)

3. 日志配置

    只有一个开启，一般用不到，不过，刚开始调试的时候可以开启，测试代码的时候可以看到输出日志，如果关闭的话就看不到了（不过这个是需要收费的~🤪）

4. 高级配置

    ![高级配置](/images/yun3.png)

    - 可以选择固定IP，用于解决ip不固定的问题（可信IP）
    - 执行超时时间改为300秒

5. 触发器配置

    ![触发器配置](/images/yun4.png)

    - 触发方式：定时触发
    - 触发周期：选择自定义触发周期，配置Cron表达式（cron写法看文档，如：`0 50 7 * * * *` 为早晨7:50）

6. 点击“完成”，开始创建，完成后，在*函数管理/函数配置*中找到**公网固定IP**，记下来

7. 配置函数代码

    ![函数代码1](/images/yun5.png)

    - 配置执行方法：默认是 `index.main_handler`，`index`指的是文件名称，`main_handler`指的是文件中的入口函数方法（代码中已默认修改好了）
    - 进入 `src` 目录、安装依赖 `npm i`（目前不安装依赖，指定`build`文件时，运行也会报错，应该是云函数脚本中存在隐藏依赖，所以无论如何都先安装依赖，准没错~）
    - 完事一定要点击下**部署**，如果你开启了日志，你可以直接点击**测试**，下面会有对应的日志输出
    - 没开启日志的情况下，直接打开终端，输入命令也是一样的 `npm run start`

    ![函数代码2](/images/yun6.png)

## 鸣谢

[MAO12366](https://github.com/MAO12366)
